services:
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: blockchain-fl-rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"      # AMQP port
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"    # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin}
      # Increase frame size limit to 10MB (default is 131072 bytes = 128KB)
      # This is a safety measure; large payloads should still use IPFS
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit frame_max 10485760"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - blockchain-fl-network

  ipfs:
    image: ipfs/kubo:latest
    container_name: blockchain-fl-ipfs
    ports:
      - "${IPFS_SWARM_PORT:-4001}:4001"      # Swarm
      - "${IPFS_API_PORT:-5001}:5001"      # API
      - "${IPFS_GATEWAY_PORT:-8080}:8080"      # Gateway
    environment:
      IPFS_PROFILE: server
    volumes:
      - ipfs_data:/data/ipfs
      - ipfs_staging:/data/ipfs/staging
    healthcheck:
      test: ["CMD", "ipfs", "version"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - blockchain-fl-network

  blockchain-service:
    build:
      context: .
      dockerfile: blockchain_service/Dockerfile
    container_name: blockchain-fl-blockchain-service
    environment:
      - BLOCKCHAIN_SERVICE_PORT=8080
      - FABRIC_NETWORK_PROFILE=${FABRIC_NETWORK_PROFILE:-network.json}
      - FABRIC_CHANNEL_NAME=${FABRIC_CHANNEL_NAME:-mychannel}
      - FABRIC_CHAINCODE_NAME=${FABRIC_CHAINCODE_NAME:-model_provenance}
    ports:
      - "${BLOCKCHAIN_SERVICE_PORT:-8081}:8080"
    networks:
      - blockchain-fl-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8080/health || curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  main-service:
    build:
      context: .
      dockerfile: main_service/Dockerfile
    container_name: blockchain-fl-main-service
    ports:
      - "${MAIN_SERVICE_PORT:-8000}:8000"
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin}
      - IPFS_HOST=ipfs
      - IPFS_PORT=5001
      - BLOCKCHAIN_SERVICE_URL=http://blockchain-service:8080
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}  # Base64-encoded 32-byte key or master password
      - API_KEY=${API_KEY:-}  # API key for authentication
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    volumes:
      - ./shared:/app/shared  # Mount shared code for development
      - ./main_service:/app/main_service  # Mount main service code for development
      # Note: Dashboard is built into the image, not mounted
      # Note: Data directory not mounted - PyTorch will download MNIST inside container if needed
    depends_on:
      rabbitmq:
        condition: service_healthy
      ipfs:
        condition: service_healthy
      blockchain-service:
        condition: service_healthy
    networks:
      - blockchain-fl-network
    restart: unless-stopped

  client-service:
    build:
      context: .
      dockerfile: client_service/Dockerfile
    # No container_name - allows scaling with docker-compose up --scale
    # Containers will be named: blockchain-fl-client-service-1, blockchain-fl-client-service-2, etc.
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin}
      - IPFS_HOST=ipfs
      - IPFS_PORT=5001
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}  # Base64-encoded 32-byte key (required for decrypting weights)
      - NUM_CLIENTS=${NUM_CLIENTS:-2}  # Total number of client replicas
      - SPLIT_TYPE=${SPLIT_TYPE:-iid}  # iid or non_iid
      - DATASET_SEED=${DATASET_SEED:-42}  # Seed for dataset splitting
      - EPOCHS=${EPOCHS:-1}  # Number of training epochs per iteration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-development}
    volumes:
      - ./shared:/app/shared  # Mount shared code for development
      - ./client_service:/app/client_service  # Mount client service code for development
      # Note: Data directory not mounted - PyTorch will download MNIST inside container if needed
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - blockchain-fl-network
    restart: unless-stopped
    # Use: docker-compose up --scale client-service=2
    # Each replica gets unique HOSTNAME: blockchain-fl-client-service-1, blockchain-fl-client-service-2, etc.

volumes:
  rabbitmq_data:
  ipfs_data:
  ipfs_staging:

networks:
  blockchain-fl-network:
    driver: bridge
